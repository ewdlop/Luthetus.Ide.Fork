<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<section xmlns="http://docbook.org/ns/docbook" version="5.0" xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="__background_task_queue_8cs_source" xml:lang="en-US">
<title>BackgroundTaskQueue.cs</title>
<indexterm><primary>Source/Lib/Common/BackgroundTasks/Models/BackgroundTaskQueue.cs</primary></indexterm>
Go to the documentation of this file.<programlisting linenumbering="unnumbered"><anchor xml:id="__background_task_queue_8cs_source_1l00001"/>00001 <emphasis role="keyword">using&#32;</emphasis>System.Collections.Immutable;
<anchor xml:id="__background_task_queue_8cs_source_1l00002"/>00002 <emphasis role="keyword">using&#32;</emphasis><link linkend="_namespace_luthetus_1_1_common_1_1_razor_lib_1_1_keys_1_1_models">Luthetus.Common.RazorLib.Keys.Models</link>;
<anchor xml:id="__background_task_queue_8cs_source_1l00003"/>00003 
<anchor xml:id="__background_task_queue_8cs_source_1l00004"/>00004 <emphasis role="keyword">namespace&#32;</emphasis><link linkend="_namespace_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models">Luthetus.Common.RazorLib.BackgroundTasks.Models</link>;
<anchor xml:id="__background_task_queue_8cs_source_1l00005"/>00005 
<anchor xml:id="__background_task_queue_8cs_source_1l00009"/><link linkend="_class_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_background_task_queue">00009</link> <emphasis role="keyword">public</emphasis>&#32;<emphasis role="keyword">class&#32;</emphasis><link linkend="_class_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_background_task_queue_1a57ef16544d002e899d824c763fd18b21">BackgroundTaskQueue</link>&#32;:&#32;<link linkend="_interface_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_i_background_task_queue">IBackgroundTaskQueue</link>
<anchor xml:id="__background_task_queue_8cs_source_1l00010"/>00010 {
<anchor xml:id="__background_task_queue_8cs_source_1l00018"/>00018 &#32;&#32;&#32;&#32;<emphasis role="keyword">private</emphasis>&#32;readonly&#32;LinkedList&lt;IBackgroundTask&gt;&#32;_queue&#32;=&#32;<emphasis role="keyword">new</emphasis>();
<anchor xml:id="__background_task_queue_8cs_source_1l00022"/>00022 &#32;&#32;&#32;&#32;<emphasis role="keyword">private</emphasis>&#32;readonly&#32;<emphasis role="keywordtype">object</emphasis>&#32;_modifyQueueLock&#32;=&#32;<emphasis role="keyword">new</emphasis>();
<anchor xml:id="__background_task_queue_8cs_source_1l00023"/>00023 
<anchor xml:id="__background_task_queue_8cs_source_1l00024"/><link linkend="_class_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_background_task_queue_1a57ef16544d002e899d824c763fd18b21">00024</link> &#32;&#32;&#32;&#32;<emphasis role="keyword">public</emphasis>&#32;<link linkend="_class_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_background_task_queue_1a57ef16544d002e899d824c763fd18b21">BackgroundTaskQueue</link>(<link linkend="_class_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_background_task_queue_1aaf229d5988553d4f3fda6e0bcdb8369b">Key&lt;IBackgroundTaskQueue&gt;</link>&#32;key,&#32;<emphasis role="keywordtype">string</emphasis>&#32;displayName)
<anchor xml:id="__background_task_queue_8cs_source_1l00025"/>00025 &#32;&#32;&#32;&#32;{
<anchor xml:id="__background_task_queue_8cs_source_1l00026"/>00026 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_class_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_background_task_queue_1aaf229d5988553d4f3fda6e0bcdb8369b">Key</link>&#32;=&#32;key;
<anchor xml:id="__background_task_queue_8cs_source_1l00027"/>00027 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_class_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_background_task_queue_1a69fa69dc58244b34fd00d6dd7fb37e1e">DisplayName</link>&#32;=&#32;displayName;
<anchor xml:id="__background_task_queue_8cs_source_1l00028"/>00028 &#32;&#32;&#32;&#32;}
<anchor xml:id="__background_task_queue_8cs_source_1l00029"/>00029 
<anchor xml:id="__background_task_queue_8cs_source_1l00030"/>00030 &#32;&#32;&#32;&#32;<emphasis role="keyword">private</emphasis>&#32;<link linkend="_interface_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_i_background_task">IBackgroundTask</link>?&#32;_executingBackgroundTask;
<anchor xml:id="__background_task_queue_8cs_source_1l00031"/>00031 
<anchor xml:id="__background_task_queue_8cs_source_1l00032"/><link linkend="_class_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_background_task_queue_1aaf229d5988553d4f3fda6e0bcdb8369b">00032</link> &#32;&#32;&#32;&#32;<emphasis role="keyword">public</emphasis>&#32;<link linkend="_class_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_background_task_queue_1aaf229d5988553d4f3fda6e0bcdb8369b">Key&lt;IBackgroundTaskQueue&gt;</link>&#32;<link linkend="_class_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_background_task_queue_1aaf229d5988553d4f3fda6e0bcdb8369b">Key</link>&#32;{&#32;<emphasis role="keyword">get</emphasis>;&#32;}
<anchor xml:id="__background_task_queue_8cs_source_1l00033"/><link linkend="_class_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_background_task_queue_1a69fa69dc58244b34fd00d6dd7fb37e1e">00033</link> &#32;&#32;&#32;&#32;<emphasis role="keyword">public</emphasis>&#32;<emphasis role="keywordtype">string</emphasis>&#32;<link linkend="_class_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_background_task_queue_1a69fa69dc58244b34fd00d6dd7fb37e1e">DisplayName</link>&#32;{&#32;<emphasis role="keyword">get</emphasis>;&#32;}
<anchor xml:id="__background_task_queue_8cs_source_1l00034"/>00034 
<anchor xml:id="__background_task_queue_8cs_source_1l00035"/><link linkend="_class_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_background_task_queue_1aabfa53a5b76d80bab65cc1250e14cc98">00035</link> &#32;&#32;&#32;&#32;<emphasis role="keyword">public</emphasis>&#32;<link linkend="_interface_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_i_background_task">IBackgroundTask</link>?&#32;<link linkend="_class_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_background_task_queue_1aabfa53a5b76d80bab65cc1250e14cc98">ExecutingBackgroundTask</link>
<anchor xml:id="__background_task_queue_8cs_source_1l00036"/>00036 &#32;&#32;&#32;&#32;{
<anchor xml:id="__background_task_queue_8cs_source_1l00037"/>00037 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keyword">get</emphasis>&#32;=&gt;&#32;_executingBackgroundTask;
<anchor xml:id="__background_task_queue_8cs_source_1l00038"/>00038 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keyword">set</emphasis>
<anchor xml:id="__background_task_queue_8cs_source_1l00039"/>00039 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{
<anchor xml:id="__background_task_queue_8cs_source_1l00040"/>00040 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;_executingBackgroundTask&#32;=&#32;value;
<anchor xml:id="__background_task_queue_8cs_source_1l00041"/>00041 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_class_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_background_task_queue_1a1cfc77a87562dff20f1be450276cc9a2">ExecutingBackgroundTaskChanged</link>?.Invoke();
<anchor xml:id="__background_task_queue_8cs_source_1l00042"/>00042 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}
<anchor xml:id="__background_task_queue_8cs_source_1l00043"/>00043 &#32;&#32;&#32;&#32;}
<anchor xml:id="__background_task_queue_8cs_source_1l00044"/>00044 
<anchor xml:id="__background_task_queue_8cs_source_1l00048"/><link linkend="_class_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_background_task_queue_1ad9bd5cba06c053983676f6ba93ab1e34">00048</link> &#32;&#32;&#32;&#32;<emphasis role="keyword">public</emphasis>&#32;<emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_class_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_background_task_queue_1ad9bd5cba06c053983676f6ba93ab1e34">Count</link>&#32;=&gt;&#32;_queue.Count;
<anchor xml:id="__background_task_queue_8cs_source_1l00049"/>00049 
<anchor xml:id="__background_task_queue_8cs_source_1l00050"/><link linkend="_class_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_background_task_queue_1a39959305bb03660d1e0b748ced1f8bb6">00050</link> &#32;&#32;&#32;&#32;<emphasis role="keyword">public</emphasis>&#32;ImmutableArray&lt;IBackgroundTask&gt;&#32;<link linkend="_class_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_background_task_queue_1a39959305bb03660d1e0b748ced1f8bb6">BackgroundTaskList</link>&#32;=&gt;&#32;_queue.ToImmutableArray();
<anchor xml:id="__background_task_queue_8cs_source_1l00051"/>00051 
<anchor xml:id="__background_task_queue_8cs_source_1l00052"/><link linkend="_class_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_background_task_queue_1abac6f64046fe171a10a4aeeab618b39c">00052</link> &#32;&#32;&#32;&#32;<emphasis role="keyword">public</emphasis>&#32;SemaphoreSlim&#32;<link linkend="_class_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_background_task_queue_1abac6f64046fe171a10a4aeeab618b39c">DequeueSemaphoreSlim</link>&#32;{&#32;<emphasis role="keyword">get</emphasis>;&#32;}&#32;=&#32;<emphasis role="keyword">new</emphasis>(0);
<anchor xml:id="__background_task_queue_8cs_source_1l00053"/>00053 
<anchor xml:id="__background_task_queue_8cs_source_1l00054"/><link linkend="_class_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_background_task_queue_1a1cfc77a87562dff20f1be450276cc9a2">00054</link> &#32;&#32;&#32;&#32;<emphasis role="keyword">public</emphasis>&#32;<emphasis role="keyword">event</emphasis>&#32;Action?&#32;<link linkend="_class_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_background_task_queue_1a1cfc77a87562dff20f1be450276cc9a2">ExecutingBackgroundTaskChanged</link>;
<anchor xml:id="__background_task_queue_8cs_source_1l00055"/>00055 
<anchor xml:id="__background_task_queue_8cs_source_1l00070"/><link linkend="_class_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_background_task_queue_1a4a7ace436716dce56754de8b6abd7d5e">00070</link> &#32;&#32;&#32;&#32;<emphasis role="keyword">public</emphasis>&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_class_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_background_task_queue_1a4a7ace436716dce56754de8b6abd7d5e">Enqueue</link>(<link linkend="_interface_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_i_background_task">IBackgroundTask</link>&#32;downstreamEvent)
<anchor xml:id="__background_task_queue_8cs_source_1l00071"/>00071 &#32;&#32;&#32;&#32;{
<anchor xml:id="__background_task_queue_8cs_source_1l00072"/>00072 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;lock&#32;(_modifyQueueLock)
<anchor xml:id="__background_task_queue_8cs_source_1l00073"/>00073 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{
<anchor xml:id="__background_task_queue_8cs_source_1l00074"/>00074 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(_queue.Count&#32;&gt;&#32;0)
<anchor xml:id="__background_task_queue_8cs_source_1l00075"/>00075 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{
<anchor xml:id="__background_task_queue_8cs_source_1l00076"/>00076 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;var&#32;upstreamEvent&#32;=&#32;_queue.Last.Value;
<anchor xml:id="__background_task_queue_8cs_source_1l00077"/>00077 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;TODO:&#32;Rename&#32;&apos;BatchOrDefault&apos;&#32;to&#32;&apos;TryMergeIntoUpstream&apos;</emphasis>
<anchor xml:id="__background_task_queue_8cs_source_1l00078"/>00078 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;var&#32;batchEvent&#32;=&#32;downstreamEvent.<link linkend="_interface_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_i_background_task_1a1297b3be631c1bb2c38c132674f61911">BatchOrDefault</link>(upstreamEvent);
<anchor xml:id="__background_task_queue_8cs_source_1l00079"/>00079 
<anchor xml:id="__background_task_queue_8cs_source_1l00080"/>00080 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(batchEvent&#32;is&#32;not&#32;<emphasis role="keyword">null</emphasis>)
<anchor xml:id="__background_task_queue_8cs_source_1l00081"/>00081 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{
<anchor xml:id="__background_task_queue_8cs_source_1l00082"/>00082 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;The&#32;length&#32;of&#32;the&#32;queue&#32;has&#32;not&#32;changed,</emphasis>
<anchor xml:id="__background_task_queue_8cs_source_1l00083"/>00083 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;so&#32;do&#32;not&#32;release&#32;the&#32;dequeue&#32;semaphore&#32;here.</emphasis>
<anchor xml:id="__background_task_queue_8cs_source_1l00084"/>00084 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//</emphasis>
<anchor xml:id="__background_task_queue_8cs_source_1l00085"/>00085 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;The&#32;batching&#32;was&#32;successful&#32;so&#32;return&#32;early.</emphasis>
<anchor xml:id="__background_task_queue_8cs_source_1l00086"/>00086 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;_queue.RemoveLast();
<anchor xml:id="__background_task_queue_8cs_source_1l00087"/>00087 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;_queue.AddLast(batchEvent);
<anchor xml:id="__background_task_queue_8cs_source_1l00088"/>00088 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>;
<anchor xml:id="__background_task_queue_8cs_source_1l00089"/>00089 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}
<anchor xml:id="__background_task_queue_8cs_source_1l00090"/>00090 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}
<anchor xml:id="__background_task_queue_8cs_source_1l00091"/>00091 
<anchor xml:id="__background_task_queue_8cs_source_1l00092"/>00092 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;The&#32;batching&#32;was&#32;NOT&#32;successful&#32;so&#32;add&#32;to&#32;the&#32;queue.</emphasis>
<anchor xml:id="__background_task_queue_8cs_source_1l00093"/>00093 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;_queue.AddLast(downstreamEvent);
<anchor xml:id="__background_task_queue_8cs_source_1l00094"/>00094 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_class_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_background_task_queue_1abac6f64046fe171a10a4aeeab618b39c">DequeueSemaphoreSlim</link>.Release();
<anchor xml:id="__background_task_queue_8cs_source_1l00095"/>00095 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}
<anchor xml:id="__background_task_queue_8cs_source_1l00096"/>00096 &#32;&#32;&#32;&#32;}
<anchor xml:id="__background_task_queue_8cs_source_1l00097"/>00097 &#32;&#32;&#32;&#32;
<anchor xml:id="__background_task_queue_8cs_source_1l00101"/><link linkend="_class_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_background_task_queue_1a1f6435764e779461fc1f59682d78532d">00101</link> &#32;&#32;&#32;&#32;<emphasis role="keyword">public</emphasis>&#32;<link linkend="_interface_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_i_background_task">IBackgroundTask</link>?&#32;<link linkend="_class_luthetus_1_1_common_1_1_razor_lib_1_1_background_tasks_1_1_models_1_1_background_task_queue_1a1f6435764e779461fc1f59682d78532d">DequeueOrDefault</link>()
<anchor xml:id="__background_task_queue_8cs_source_1l00102"/>00102 &#32;&#32;&#32;&#32;{
<anchor xml:id="__background_task_queue_8cs_source_1l00103"/>00103 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;lock&#32;(_modifyQueueLock)
<anchor xml:id="__background_task_queue_8cs_source_1l00104"/>00104 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;{
<anchor xml:id="__background_task_queue_8cs_source_1l00105"/>00105 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(_queue.Count&#32;&lt;=&#32;0)
<anchor xml:id="__background_task_queue_8cs_source_1l00106"/>00106 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;<emphasis role="keyword">null</emphasis>;
<anchor xml:id="__background_task_queue_8cs_source_1l00107"/>00107 
<anchor xml:id="__background_task_queue_8cs_source_1l00108"/>00108 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;var&#32;task&#32;=&#32;_queue.First.Value;
<anchor xml:id="__background_task_queue_8cs_source_1l00109"/>00109 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;_queue.RemoveFirst();
<anchor xml:id="__background_task_queue_8cs_source_1l00110"/>00110 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;task;
<anchor xml:id="__background_task_queue_8cs_source_1l00111"/>00111 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}
<anchor xml:id="__background_task_queue_8cs_source_1l00112"/>00112 &#32;&#32;&#32;&#32;}
<anchor xml:id="__background_task_queue_8cs_source_1l00113"/>00113 }
</programlisting></section>
